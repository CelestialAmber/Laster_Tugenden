<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title>UWOG</title>
	<style>



.quickshake {
    -webkit-animation: pulsateb 0.5s ease-out;
    /*-webkit-animation-iteration-count: once; */
    opacity: 0;
    float: right;
    position:absolute;
}
@-webkit-keyframes pulsateb {
    0% { 
        opacity: 1;
        transform: translate(0px, 0px);
        font-size: 100%;
    }
    50% { 
        opacity: 0.5;
        transform: translate(5px, -10px);
        font-size: 120%;
    }
    100% { 
        opacity: 0;
        transform: translate(10px, -20px);
        font-size: 100%;
    }
}

abbr {
text-decoration: none !important;
border-bottom: 0px !important;
}



.fadeout {
    -webkit-animation: pulsateb 0.5s ease-out;
    /*-webkit-animation-iteration-count: once; */
    opacity: 0;
    float: right;
    position:absolute;
}
@-webkit-keyframes pulsateb {
    0% { 
        opacity: 1;
        transform: translate(0px, 0px);
        font-size: 100%;
    }
    50% { 
        opacity: 0.5;
        transform: translate(5px, -10px);
        font-size: 120%;
    }
    100% { 
        opacity: 0;
        transform: translate(10px, -20px);
        font-size: 100%;
    }
}

.pulsate {
    -webkit-animation: pulsate 0.5s ease-out;
    -webkit-animation-iteration-count: infinite; 
    opacity: 0.5;
}
@-webkit-keyframes pulsate {
    0% { 
        opacity: .2;
        font-size: 100%;
    }
    50% { 
        opacity: 1;
        font-size: 120%;
    }
    100% { 
        opacity: .2;
        font-size: 100%;
    }
}
		ul{
			display :inline-block;
		}
		body {

		  max-width: 600px;
		  margin: auto;
		  padding-top: 10px;
		}
		h1{
			text-align: center;
		}
		table {
  			border-collapse: collapse;
		}
		table {
			border:none;
		}
		th, td {
		  border: 1px solid black;
		}
		td {
			width:100pt;
			text-align: center;
		}
		.oben {
			border-top: none;
		}
		.obenleft {
			/*border-left: none;*/
		}
		.obenright {
			/*border-right: none;*/
		}
		#line {
			font-weight: bold;
			text-align: center;
			font-size: 150%;

		}
		#selected {
			font-weight: bold;
			text-align: center;
		}
		.virtue {	
			/*font-family: 'Playfair Display', serif;*/
			color:green;
		}
		.vices {
			/*font-family: 'UnifrakturMaguntia', cursive;*/
			color:red;
		}
		.draw {
			/*font-family: 'UnifrakturMaguntia', cursive;*/
			/*color:gray;*/
			/*alpha:0.5;*/
			/*background-color: lightgray;*/
			opacity: 0.5;
		}
		.side {
			width:30pt;
		  	border-left: none;
		  	border-right: none;
		  	text-align: center;	
		}
		.emside {
			width:30pt;
			border:none;
		}
		.status {
			height:50pt;
		}
		.good {
			background-color: lightgreen;
		}
		.evil {
			background-color: pink;
		}
		.goodbad {			
			height:50pt;
			border:none;
			font-weight: bold;
			font-size: 200%;
		}
		.healtextclass {
			color:blue;
		}
		.damagetextclass {
			color:brown;
		}
		.invis {
			border:none;
		}
		#score {
			text-align: left;
			border:none;
			font-weight: none;
		}
		button {			
			/*border:none;*/
			font-weight: bold;
			font-size: 100%;
		}
		#goodbutton {
			background-color: lightgreen;
		}
		#badbutton {
			background-color: pink;
		}

		/*from w3schools*/

		/* Tooltip container */
.tooltip {
  position: relative;
  display: inline-block;
  border-bottom: 1px dotted black; 
  /* If you want dots under the hoverable text */
}

/* Tooltip text */
.tooltip .tooltiptext {
font-weight: normal;
  visibility: hidden;
  width: 300px;
  background-color: #555;
  color: #fff;
  text-align: left;
  padding: 5px 5px;
  border-radius: 6px;

  /* Position the tooltip text */
  position: absolute;
  z-index: 1;
  bottom: 100%;
  left: 50%;
  margin-left: -60px;

  /* Fade in tooltip */
  opacity: 0;
  transition: opacity 0.3s;
}

/* Tooltip arrow */
.tooltip .tooltiptext::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 12%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: #555 transparent transparent transparent;
}

/* Show the tooltip text when you mouse over the tooltip container */
.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
  pointer-events: none;

}
	</style>
</head>
<body>
	<h1>UWOG</h1>
	<p>

<table id="maintable">
		<tr>
		<td class="emside">
		</td>
		<td class="goodbad" colspan="2">
			<button type="button" id="goodbutton"  accesskey="s">Thou shalt </button>
		</td>
		<td class="goodbad"  colspan="2">
			<button type="button" id="badbutton"  accesskey="n">Thou shalt <u>not</u></button>
		</td>
		<td class="emside">
		</td>
	</tr>
		<tr>
		<td class="emside">
		</td>
		<td id="score">
			Score:<span id="scoretxt">0</span> (High:<span id="maxscore">0</span>)
		</td>
		<td class="invis">
		</td>
		<td class="invis">
		</td>
		<td class="invis">
		</td>
		<td class="emside">
		</td>
	</tr>

	<tr class="oben">
		<td class="emside">
		</td>
		<td id="r1c1" class="oben obenleft">⋮
		</td>
		<td id="r1c4" class="oben">⋮
		</td>
		<td id="r1c4" class="oben">⋮
		</td>
		<td id="r1c4" class="oben obenright">⋮
		</td>
		<td class="emside">
		</td>
	</tr>

</table>

<p>
	<button type="button" id="newgamebutton" >New Game</button>
	<p>
		<ul>
		<li>Being virtuous +1 health.
		<li>Not being virtuous -1 health.
		<li>Avoiding vices +1 health.
		<li>Committing vices -1 health.
		<li>People who have forsworn a crime will inflict -1 additional damage on perpetrators.
		<li>People who follow a particular virtue will punish those who neglect it with -1 damage.
		<li>People remember what you've told them. If they are in the same sitaution in future, they will automatically carry out the requested behaviour.
	</ul>
		(You can mouse hover over cells in the top 3 rows to find out what their effect will be).
<p>
	<center><a href="https://www.increpare.com">home</a></center>
	<p>
<script type="text/javascript">
	var state=[];

	var agent_num = 4;
	var command_num = 14;
	var front_line_num = 2;

	var emoji = ['🤡','🤖','💩','👽'];
	var todemoji='💀';
	var starthealth=4;


	var goodButton;
	var badButton;
	var newGameButton;


	// var virtues = [
	// // 'Demut','Mildtätigkeit','Keuschheit','Geduld','Mäßigung','Wohlwollen','Fleiß'
	// // 'humilitas','caritas','castitas','patientia','temperantia','humanitas','industria'
	// ];
	// var vices = [
	// // 'Hochmut','Habgier','Wollust','Zorn','Völlerei','Neid','Faulheit'
	// ];

	var virtues = ['Faith','Valour','Charity','Diligence','Patience','Kindness','Humility'];

	var vices = ['Murder','Bestiality','Sodomy','Theft','Stalking','Vulgarity','Rebellion'];
	var words = virtues.concat(vices);
	
	function getHighScore(){
		try {
			var storagedHighScore = localStorage.getItem("highscore");
			var highscore=0;
			if (storagedHighScore!=null){
				highscore=parseInt(storagedHighScore);
			}
			return highscore;
		} catch(e){
			return 0;
		}
	}
	function setHighScore(){
		try {
			var hs = getHighScore();
			if (hs<state.score){
				localStorage.setItem("highscore",state.score);
			}
		} catch(e){

		}
	}

	function isVirtuous(w){
		return virtues.indexOf(w)>=0;
	}

	function getWord(){
		return words[Math.floor(Math.random()*words.length)];
	}

	function commandWorth(agent,word){
		// return (word.length%3)-1;

		for (var i=0;i<command_num;i++){
			var commandment = state.commandments[agent][i];
			if (commandment.length===0){
				continue;
			}
			if (commandment[1]===0){
				continue;
			}
			if (commandment[0]==word){
				return commandment[1];
			}
		}
		return 0;
	}

	function setState(){

		document.getElementById("scoretxt").innerHTML=state.score;

		for (var i=0;i<agent_num;i++){
			var elem = document.getElementById('health'+i);
			if (state.healths[i]>0){
				if (state.healths[i]<3 &&!lost()){
					elem.innerHTML=`${emoji[i]} <span class="pulsate">${state.healths[i]}</span>`;
				} else {
					elem.innerHTML=`${emoji[i]} ${state.healths[i]}`;										
				}

			} else {
				elem.innerHTML=todemoji+" "+ state.healths[i];
			}
			if (state.healths[i]!==state.oldhealths[i]){
				var delta = state.healths[i]-state.oldhealths[i];
				var deltas = ""+delta;
				if (delta>0){
					deltas = "+"+deltas;
				}
				elem.innerHTML+=`<span class="fadeout ${delta>0?"healtextclass":"damagetextclass"}">(${deltas})</span>`;
				state.oldhealths[i]=state.healths[i];
			}
		}

		for (var i=0;i<agent_num;i++){
			for (var j=0;j<front_line_num;j++){
				var elem = document.getElementById(`v${j}c${i}`);
				var word = state.front[i][j];
				elem.innerHTML=euphemism(word,i);

				var value = commandWorth(i,word);
				switch(value){
					case -1:
					elem.className="evil";
					break;
					case 0:
					elem.className="";
					break;
					case 1:
					elem.className="good";
					break;
				}
			}
		}

		for (var i=0;i<agent_num;i++){
			for (var j=0;j<command_num;j++){
				var elem = document.getElementById(`g${j}c${i}`);
				var commandment = state.commandments[i][j];
				if (commandment.length===0){
					elem.innerHTML="&nbsp;";
					elem.className="";
					continue;
				}
				var value = commandWorth(i,commandment[0]);
				switch(value){
					case -1:
					elem.className="commandment cell evil";
					break;
					case 0:
					elem.className="commandment cell draw";
					break;
					case 1:
					elem.className="commandment cell good";
					break;
				}
				elem.innerHTML=euphemism(commandment[0],-1);
			}
		}

		// state.commandments=[];
		// for (var i=0;i<agent_num;i++){
		// 	state.commandments.push([]);
		// 	for (var j=0;j<command_num;j++){
		// 		state.commandments[i].push(getWord());
		// 	}
		// }

		// state.line=[];
		for (var i=0;i<agent_num;i++){
			var elem = document.getElementById(`agw${i}`);
			var word = state.line[i];
			elem.innerHTML=euphemism(word,i);


				var value = commandWorth(i,word);
				switch(value){
					case -1:
					elem.className="evil";
					break;
					case 0:
					elem.className="";
					break;
					case 1:
					elem.className="good";
					break;
				}

		// 	state.line.push(getWord());
		}

		if (lost()){			
			goodButton.disabled=true;
			badButton.disabled=true;
			var hs = getHighScore();
			var text = `Game over.\nYour score was ${state.score} :)`;
			if (hs<state.score){
				text+="\nNew high score!";
			} else {
				text+=`\n(High Score : ${hs})`
			}

			alert(text);
			setHighScore(state.score);
		}
		document.getElementById("maxscore").innerHTML=getHighScore();
	}

	var highlightrow=-1;
	var highlightrow2=-1;
	var stylesheet = document.styleSheets[0];

	function after_onmouseenter(row,agent){
		var word = state.front[agent][row];
		var wortindex = words.indexOf(word);
		highlightrow=stylesheet.insertRule(`.commandmentrow${wortindex} .commandment cell{ } `);
		highlightrow2=stylesheet.insertRule(`.commandmentrow${wortindex} { border: 1px solid black; background-color:white; }`);
	}
	
	function after_onmouseleave(agent,row){
		if (highlightrow>=0){
			stylesheet.deleteRule(highlightrow);
			stylesheet.deleteRule(highlightrow2);
			highlightrow=-1;
		}
	}


	function agw_onmouseenter(agent){

		var word = state.line[agent];
		var wortindex = words.indexOf(word);
		highlightrow=stylesheet.insertRule(`.commandmentrow${wortindex} .commandment cell{ } `);
			highlightrow2=stylesheet.insertRule(`.commandmentrow${wortindex} { border: 1px solid black; background-color:white; }`);
	}
	
	function agw_onmouseleave(i,j){
		if (highlightrow>=0){
			stylesheet.deleteRule(highlightrow);
			stylesheet.deleteRule(highlightrow2);
			highlightrow=-1;
		}
	}

	function generateTable(){

		var table = document.getElementById('maintable');

		state={};
		state.score=0;
		state.healths=[];
		state.oldhealths=[];
		for (var i=0;i<agent_num;i++){
			state.healths.push(starthealth);
			state.oldhealths.push(starthealth);
		}

		state.front=[];
		for (var i=0;i<agent_num;i++){
			state.front.push([]);
			for (var j=0;j<command_num;j++){
				state.front[i].push(getWord());
			}
		}

		state.commandments=[];
		for (var i=0;i<agent_num;i++){
			state.commandments.push([]);
			for (var j=0;j<command_num;j++){
				state.commandments[i].push([words[j],0]);
			}
		}

		state.line=[];
		for (var i=0;i<agent_num;i++){
			state.line.push(getWord());
		}

		var inner = "";

		for (var i=0;i<front_line_num;i++){
			inner += `
	<tr>
		<td class="emside">
		</td>`

			for (var j=0;j<agent_num;j++){
				inner +=`<td  onmouseenter="after_onmouseenter(${i},${j})" onmouseleave="after_onmouseleave(${i},${j})" id="v${i}c${j}">
			platzhalter
		</td>`
			}

			inner +=`
		<td class="emside">
		</td>
	</tr>`

		}

		inner+= `
	<tr id="selected">
		<td class="side">
			->
		</td>`


			for (var j=0;j<agent_num;j++){
				inner +=`<td  onmouseenter="agw_onmouseenter(${j})" onmouseleave="agw_onmouseleave(${i},${j})"  id="agw${j}">
			platzhalter
		</td>`
			}

		inner+=`
		<td class="side">
			&lt;-
		</td>
	</tr>`

		inner+=`
	<tr class="status" id ="line">
		<td class="emside">
		</td>`


			for (var j=0;j<agent_num;j++){
				inner +=`
		<td id="health${j}">
			666
		</td>`
			}


		inner+=`
		<td class="emside">
		</td>
	</tr>`


		for (var i=0;i<command_num;i++){
			inner += `
	<tr class="commandmentrow${i}">
		<td class="emside">
		</td>`

			for (var j=0;j<agent_num;j++){
				inner +=`<td id="g${i}c${j}">
			platzhalter
		</td>`
			}

			inner +=`
		<td class="emside">
		</td>
	</tr>`

		}
		table.innerHTML +=  inner;
	}

	function shouldAnimate(){		
		if (lost()){
			return false;
		}

		for (var i=0;i<agent_num;i++){
			var word = state.line[i];
			if (commandWorth(i,word)!==0){
				return true;
			}
		}
	}

	function tueTick(){
		for (var i=0;i<agent_num;i++){
			var word = state.line[i];
			if (commandWorth(i,word)!==0){
				var value = commandWorth(i,word);
				commandColumn(i,value,false);
			}
		}

		if (full()&& lost()===false){
			state.score++;		
		}


		if (shouldAnimate()){
			startWithAnimation();
		} else {
			goodButton.disabled=false;
			badButton.disabled=false;
			newGameButton.disabled=false;
		}

		setState();
	}

	function startWithAnimation(){
		goodButton.disabled=true;
		badButton.disabled=true;
		newGameButton.disabled=true;

		setTimeout(tueTick,500);
	}

	function lost(){
		for (var i=0;i<agent_num;i++){
			if (state.healths[i]<=0){
				return true;
			}
		}
		return false;
	}

	function full(){
		for (var i=0;i<agent_num;i++){
			for (var j=0;j<command_num;j++){
				if (state.commandments[i][j][1]===0){
					return false;
				}
			}
		}
		return true;
	}

	function commandment(value){
		for (var i=0;i<agent_num;i++){
			commandColumn(i,value,true);
		}
		
		if (shouldAnimate()){
			startWithAnimation();
		}

		if (!lost()){
			state.score++;
		}
		setState();
	}

	function commandColumn(agent,value,add){
		var i=agent;
		//1 move down commandments

		// if (add){
		// 	for (var j=command_num-1;j>=0;j--){
		// 		state.commandments[i][j+1]=state.commandments[i][j];
		// 	}
		// }

		//2 move the active line down + set value

		var commandmentLine = words.indexOf(state.line[i]);
		if (add){
			state.commandments[i][commandmentLine][1]=value;
		}

			var delta=0;
			if (isVirtuous(state.line[i])){
				delta=value;
			} else {
				delta=-value;
			}

			{
				var word = 	state.line[i];

				//for every other character
				for (var o=0;o<agent_num;o++){
					if (o===agent){
						continue;
					}

					var virtue = isVirtuous(word);
					var o_does = commandWorth(o,word);
					
					 // if you fail to do something good that they value, they will punish you
					if (value==-1 && virtue===true && o_does===1){
						delta-=1;
					}

					//if you do something evil that they are not allowed to do, they will punish you
					if (value==1 && virtue===false && o_does===-1){
						delta-=1;
					}
				}
				state.healths[i]+=delta;
				if (state.healths[i]<0){
					state.healths[i]=0;
				}
			}

		//3 move down the preview line

			state.line[i]=state.front[i][front_line_num-1];


		//4 move preview line down

			for (var j=front_line_num-1;j>=0;j--){
				state.front[i][j+1]=state.front[i][j];
			}

		//5 draw again

			state.front[i][0]=getWord();


		//6 start animation if relevant
	}

	function clickOnGood(){
		if (goodButton.disabled){
			return;
		}
		commandment(1);
	}
	
	function clickOnBad(){
		if (badButton.disabled){
			return;
		}
		commandment(-1);
	}
	
	function clickOnNew(){
		location.reload();
	}

	function signInt(i){
		if (i<0){
			return ""+i;
		} else {
			return "+"+i;
		}		
	}

	function euphemism(w,agent,tooltiperlauben){
		var virtue = isVirtuous(w);
		tooltiperlauben=false;//agent>=0;

		if (agent>=0){
			var delta=0;

			var disapproves=[];
			for (var o=0;o<agent_num;o++){
				if (o===agent){
					continue;
				}

				var o_does = commandWorth(o,w);
				
				 // if you fail to do something good that they value, they will punish you
				if (virtue===true && o_does===1){
					delta++;
					disapproves.push(emoji[o]);
				}

				//if you do something evil that they are not allowed to do, they will punish you
				if (virtue===false && o_does===-1){
					delta++;
					disapproves.push(emoji[o]);
				}
			}



			var wortindex = words.indexOf(w);
			var compulsory = state.commandments[agent][wortindex][1];
			var tooltip="";

			var bigeffect = signInt(-1-disapproves.length)+` = -1 (${virtue?"virtue":"vice"})`;
			if (disapproves.length===1){
				bigeffect+=` -1 (${disapproves[0]} disapproves)`				
			} else if (disapproves.length>1){
				bigeffect += ` -${disapproves.length} (`
				for (var i=0;i<disapproves.length;i++){
					bigeffect+=disapproves[i];
				}
				bigeffect+=` disapprove)`
			}

			if (disapproves.length===0){
				bigeffect = `-1 (${virtue?"virtue":"vice"})`;
			}

			if (virtue){
				tooltip = "Do: +1 (virtue)\nDon't do: "+bigeffect;
			} else {
				tooltip = "Do: "+bigeffect+"\nDon't do: +1 (vice)";
			}


			// var tooltip=
			if (delta!==0){
				w+='<sup>';
				for (var i=0;i<delta;i++){
					w+='†';
				}
				w+='</sup>';
			}

			if (tooltip.length>0){
				// w +=`<span class="tooltiptext">${tooltip}</span>`
				w=`<abbr title="${tooltip}">${w}</abbr>`
			}
		}

		if (virtue){
			w = `<span class="virtue ${(tooltiperlauben===true)?"tooltip":""}">${w}</span>`;
		} else {
			w = `<span class="vices ${(tooltiperlauben===true)?"tooltip":""}">${w}</span>`;
		} 

		return w; 
	}

	function closeButtons(){

		goodButton = document.getElementById('goodbutton');
		badButton = document.getElementById('badbutton');
		newGameButton = document.getElementById('newgamebutton');

		goodButton.addEventListener("click", clickOnGood);
		badButton.addEventListener("click", clickOnBad);
		newGameButton.addEventListener("click", clickOnNew);

	}


	generateTable();
	setState();
	closeButtons();

</script>
</body>
</html>